/* $Id$ */

/*!
\defgroup CR_Imaging CR-Tools :: Imaging module
\ingroup CR

\brief Imaging module for the CR-pipeline

  - \ref crtools_imaging_geometry
  - \ref crtools_imaging_frames
  - \ref crtools_imaging_implementation
  - \ref crtools_imaging_references

<hr>

\section crtools_imaging_geometry Basic geometry and conventions

\image html beamforming-geometry.png

For the beamforming process we adopt the geometry as shown in the figure above,
from this we derive the following fundamental statements:
<ol>
  <li>Coordinates are given within a cartesian coordinate system frame 
  tied to the center of the array; its origin is designated by
  \f$\vec O = (0,0,0)\f$.
  <li>\f$ \vec x_i \f$ is the  three-dimensional position vector of the
  i-th array antenna, pointing away from the coordinate system origin.
  <li>\f$ \vec \rho_i \f$ denotes the direction vector from the position of
  the i-th antenna towards the position of the source.
  <li>Baseline vectors originate from the chosen phase center; the baseline
  vector between a pair of antennae <i>i</i> and <i>j</i> as therefore is
  given by
  \f[ \vec B_{ij} = \vec x_{j} - \vec x_{i} \f]
  The coordinates of the default array phase center are \f$\vec O = (0,0,0)\f$,
  hence \f$\vec B_j = \vec x_j\f$.
  <li>The light travel time delay, \f$\tau_{ij}\f$, between two antennae
  <i>i</i> and <i>j</i> is defined following the convention for the baselines,
  \f[ \tau_{ij} = \frac{1}{c}\, \Bigl( |\vec \rho_j| - |\vec \rho_i| \Bigr) \f]
  thus \f$\tau_{ij} > 0\f$ if the signal arrives at antenna <i>i</i> before
  arriving at antenna <i>j</i>.
</ol>

<table border=0>
<tr>
<td>\image html Plane.gif</td>
<td>\image html PointPlaneDistance.gif</td>
</tr>
</table>

<hr>

\section crtools_imaging_frames Reference frames

A Terrestrial Reference System (TRS) is a spatial reference system co-rotating
with the Earth in its diurnal motion in space. In such a system, positions of
points anchored on the Earth solid surface have coordinates which undergo only
small variations with time, due to geophysical effects (tectonic or tidal
deformations). A Terrestrial Reference Frame (TRF) is a set of physical points
with precisely determined coordinates in a specific coordinate system (cartesian,
geographic, mapping...) attached to a Terrestrial Reference System. Such a TRF
is said to be a realization of the TRS.

<ol>
  <li><i>Ideal Terrestrial Reference Systems.</i> <br>
  An ideal Terrestrial Reference System (TRS) is defined as a tri-dimensional
  reference frame (in the mathematical sense) close to the Earth and co-rotating
  with it. In the newtonian background, the geometry of the physical space
  considered as an euclidian affine space of dimension 3 provides a standard
  and rigorous model of such a system through the selection of an affine frame
  (O,E). O is a point of the space named origin. E is a vector base of the
  associated vector space.The currently adopted restrictions to E are to be
  orthogonal with same length for the base vectors. Moreover, one adopts a direct
  orientation. The common length of these vectors will express the scale of the
  TRS and the set of unit vectors collinear to the base its orientation:
  \f[ \lambda = || \vec{E}_i ||_{i=1,2,3} \f]
  In the context of IERS, we consider the geocentric systems where the origin
  is close to the geocenter and the orientation is equatorial (Z axis is the
  direction of the pole). In this case, cartesian coordinates, geographical
  coordinates or plane (map) coordinates are currently used.<br>
  Under these hypothesis, the general transformation of the cartesian
  coordinates of any point close to the Earth from a TRS (1) to a TRS (2) will
  be given by a tri-dimensional similarity (\f$ T_{1,2} \f$ is a translation
  vector, \f$ \lambda_{1,2} \f$ a scale factor and \f$ R_{1,2} \f$ a rotation
  matrix):
  \f[ X^{(2)} = T_{1,2} + \lambda_{1,2} \cdot R_{1,2} X^{(1)} \f]

  <li><i>Conventional Terrestrial Reference System (CTRS).</i><br>
  Such a system designates the set of all conventions, algorithms and constants
  which determine the estimation of coordinates of points in a specific ideal TRS.

  <li><i>Conventional Terrestrial Reference Frame (CTRF).</i><br>
  A Conventional Terrestrial Reference Frame is defined as a set of physical
  points with precisely determined coordinates in a specific coordinate system
  as a realization of an ideal Terrestrial Reference System. Two types of
  frames are currently distinguished (this is also valid for celestial
  references), namely dynamical or kinematical ones, depending whether a
  dynamical model is applied in the determination process of these coordinates,
  or not.

  <li><i>Earth Centred Earth Fixed (ECEF) coordinates</i> <br>
  The Earth-centred Earth-fixed (ECEF) or conventional terrestrial coordinate
  system rotates with the Earth and has its origin at the centre of the Earth.
  The \f$X\f$ axis passes through the equator at the prime meridian. The \f$Z\f$ axis
  passes through the north pole. The \f$Y\f$ axis can be determined by the
  right-hand rule to be passing through the equator at \f$90^{\circ}\f$ longitude.

  <li><i>Local east, north, up (ENU) coordinates</i> <br>
  In many targeting and tracking applications the local East, North, Up (ENU)
  Cartesian coordinate system is far more intuitive and practical than ECEF or
  Geodetic coordinates. The local ENU coordinates are formed from a plane tangent
  to the Earth's surface fixed to a specific location and hence it is sometimes
  known as a "Local Tangent" or "local geodetic" plane. By convention the east
  axis is labeled \f$x\f$, the north \f$y\f$ and the up \f$z\f$.

  <li><i>Local north, east, down (NED) coordinates</i> <br>
  In an aeroplane most objects of interest are below you, it is therefore
  sensible to define down as a positive number, the NED coordinates allow you
  to do this as an alternative the ENU local tangent plane. By convention the
  north axis is labeled \f$x'\f$, the east \f$y'\f$ and the down \f$z'\f$. To
  avoid confusion between \f$x\f$ and \f$x'\f$, etc in this web page we will
  restrict the local coordinate frame to ENU.
</ol>

The standard relation of transformation between two reference systems is an
Euclidian similarity of seven parameters: three translation components, one
scale factor, and three rotation angles, designated respectively, T1, T2, T3,
D, R1, R2, R3, and their first times derivations : \f$ \dot{T1} \f$, 
\f$ \dot{T2} \f$, \f$ \dot{T3} \f$, \f$ \dot{D} \f$, \f$ \dot{R1} \f$,
\f$ \dot{R2} \f$, \f$ \dot{R3} \f$. The transformation of coordinate vector
\f$ X_1 \f$, expressed in a reference system (1), into a coordinate vector
\f$ X_2 \f$, expressed in a reference system (2), is given by the following
equation:
\f[ X_2 = X_1 + T + D X_1 + R X_1 \f]
with :
\f[
T = \left( \begin{array}{c} T1 \\ T2 \\ T3 \end{array} \right)
\quad \hbox{and} \qquad
R = \left( \begin{array}{ccc} 0 & -R3 & R2 \\ R3 & 0 & -R1 \\ -R2 & R1 & 0
\end{array} \right)
\f]
It is assumed that first equation is linear for sets of station coordinates
provided by space geodetic technique (origin difference is about a few hundred
meters, and differences in scale and orientation are of \f$ 10^{-5} \f$ level).
Generally, X1, X2, T, D, R are function of time.

<hr>

\section crtools_imaging_implementation Implementation

Image array:
\f[  I = I (\xi_1,\xi_2,\xi_3,\nu,t)  \in C^5 \f]

<h4>Coordinates</h4>

Out of the five standard coordinate axes associated with the image array, two
groups of coupled coordinate axes exist; in order to take account of that fact
and provide the programmer/user with an interface reflecting these
relationships, two custom coordinate object classes have been created:
<ol>
  <li>CR::SpatialCoordinate - Container to combine other coordinates into a
  spatial (3D) coordinate.
  <li>CR::TimeFreqCoordinate - Container for the time-frequency domain
  parameters of a skymap.
</ol>
For both classes the following methods are provided:
<ul>
  <li>Interfaces to the WCS parameters describing the the relationship between
  pixel and world coordinates:
  <ul>
	<li>worldAxisNames
	<li>worldAxisUnits
	<li>referencePixel
	<li>referenceValue
	<li>linearTransform
	<li>increment
	<li>toWorld
	<li>toPixel
  </ul>
  <li>Export of the coordinate objects to a coordinate system.
  <ul>
    <li>toCoordinateSystem
  </ul>
</ul>

The above mentioned coordinate objects contain the major fraction of the data
which are collected within an object of type CR::SkymapCoordinate.

<h4>Beamforming</h4>

The functionality required for beamforming and subsequent imaging is broken
down into a number of classes.

<table border="0">
  <tr>
    <td class="indexkey">Quantity</td>
    <td class="indexkey">implemented in</td>
    <td class="indexkey">Relation</td>
  </tr>
  <tr>
    <td>gemoetrical delay</td>
    <td>CR::GeomDelay</td>
    <td>\f$ \tau_j = \frac{1}{c} \left( |\vec \rho - \vec x_j| - |\vec \rho|
    \right) \f$</td>
  </tr>
  <tr>
    <td>geometrical phase</td>
    <td>CR::GeomPhase</td>
    <td>\f$ \phi (\vec x_j, \vec \rho, \nu) = 2 \pi \nu \tau_{\rm geom} \f$</td>
  </tr>
  <tr>
    <td>geometrical weight</td>
    <td>CR::GeomWeight</td>
    <td>\f$ w (\vec x_j, \vec \rho, \nu) = \exp \Bigl( i\, \phi (\vec x_j,
    \vec \rho, \nu) \Bigr) \f$</td>
  </tr>
</table>

In order to use the slicing operations, the arrays internally used by the
Skymapper or the Beamformer need to be of equal rank -- otherwise the
<tt>putSlice()</tt> and <tt>getSlice()</tt> operations are not well defined (or at
least give trouble.

\code
IPosition start (5,0);

for (uint block(0); block<nofBlocks; block++) {
  for (uint channel(0); channel<nofChannels; channel++) {
    /* do something with the data */
    start(3)++;
  }
  start(3)=0;
  start(4)++;
}
\endcode

<hr>

\section crtools_imaging_references References
  
  <ul>
    <li>casacore <a href="http://www.astron.nl/casacore/doc/html/classcasa_1_1Coordinate.html">Coordinate</a> class
	<li>casacore <a href="http://www.astron.nl/casacore/doc/html/group__Measures__module.html">Measures</a> module
    <li><a href="http://itrf.ensg.ign.fr">itrf.ensg.ign.fr</a>
    <li><a href="http://www.iers.org">International Earth Rotation and Reference
    System Service</a>
    <li>Least-squares image estimation on a multiresolution pyramid. Clippingdale, S.C.; Wilson, R.G. Acoustics, Speech, and Signal Processing, 1989. ICASSP-89., 1989 International Conference on Volume , Issue , 23-26 May 1989 Page(s):1409 - 1412 vol.3
    <li><a href="http://www.gb.nrao.edu/ovlbi/es70_stationLocation.txt">NRAO orbiting VLBI earth station coordinates</a>
    <li><a href="http://mathworld.wolfram.com/Point-PlaneDistance.html">Point-Plane Distance</a> (MathWorld)
  </ul>


*/
