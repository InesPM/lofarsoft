##------------------------------------------------------------------------------
## $Id:: CMakeLists.txt 489 2007-08-01 11:40:38Z baehren                       $
##------------------------------------------------------------------------------

## -----------------------------------------------------------------------------
## Create "config.h"
##
## When using the GNU Autotools this typically is created by configure from
## config.h.in - since we bypass this setup but the source code requires the
## settings, we need to create the file here.

include (CheckFunctionExists)

set (WCSLIB_config ${WCSLIB_BINARY_DIR}/C/config.h)

file (WRITE ${WCSLIB_config} "/* C/config.h  --  Generated by CMake. */\n\n")

## Check for CFITSIO ----------------------------

if (HAVE_CFITSIO)
  file (APPEND ${WCSLIB_config} "\#define HAVE_CFITSIO 1\n\n")
endif (HAVE_CFITSIO)

## Check for libm library -----------------------

if (libm)
  file (APPEND ${WCSLIB_config} "\#define HAVE_LIBM 1\n\n")
endif (libm)

## Check for <errno.h> --------------------------

check_include_files (errno.h HAVE_ERRNO_H)

if (HAVE_ERRNO_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <errno.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_ERRNO_H 1\n\n")
endif (HAVE_ERRNO_H)

## Check for <inttypes.h> -----------------------

check_include_files (inttypes.h HAVE_INTTYPES_H)

if (HAVE_INTTYPES_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <inttypes.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_INTTYPES_H 1\n\n")
endif (HAVE_INTTYPES_H)

## Check for <limits.h> -----------------------

check_include_files (limits.h HAVE_LIMITS_H)

if (HAVE_LIMITS_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <limits.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_LIMITS_H 1\n\n")
endif (HAVE_LIMITS_H)

## Check for <math.h> -----------------------

check_include_files (math.h HAVE_MATH_H)

if (HAVE_MATH_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <math.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_MATH_H 1\n\n")
endif (HAVE_MATH_H)

## Check for <memory.h> -----------------------

check_include_files (memory.h HAVE_MEMORY_H)

if (HAVE_MEMORY_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <memory.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_MEMORY_H 1\n\n")
endif (HAVE_MEMORY_H)

## Check for <stdint.h> -----------------------

check_include_files (stdint.h HAVE_STDINT_H)

if (HAVE_STDINT_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <stdint.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_STDINT_H 1\n\n")
endif (HAVE_STDINT_H)

## Check for <stdio.h> -----------------------

check_include_files (stdio.h HAVE_STDIO_H)

if (HAVE_STDIO_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <stdio.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_STDIO_H 1\n\n")
endif (HAVE_STDIO_H)

## Check for <stdlib.h> -----------------------

check_include_files (stdlib.h HAVE_STDLIB_H)

if (HAVE_STDLIB_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <stdlib.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_STDLIB_H 1\n\n")
endif (HAVE_STDLIB_H)

## Check for <strings.h> -----------------------

check_include_files (strings.h HAVE_STRINGS_H)

if (HAVE_STRINGS_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <strings.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_STRINGS_H 1\n\n")
endif (HAVE_STRINGS_H)

## Check for <string.h> -----------------------

check_include_files (string.h HAVE_STRING_H)

if (HAVE_STRING_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <string.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_STRING_H 1\n\n")
endif (HAVE_STRING_H)

## Check for <stat.h> -----------------------

find_path (HAVE_SYS_STAT_H stat.h
  PATHS ${include_locations}
  PATH_SUFFIXES sys
)

if (HAVE_SYS_STAT_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <stat.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_SYS_STAT_H 1\n\n")
endif (HAVE_SYS_STAT_H)

## Check for <types.h> --------------------------

find_path (HAVE_SYS_TYPES_H types.h
  PATHS ${include_locations}
  PATH_SUFFIXES sys
)

if (HAVE_SYS_TYPES_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <types.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_SYS_TYPES_H 1\n\n")
endif (HAVE_SYS_TYPES_H)

## Check for <unistd.h> -------------------------

find_path (HAVE_UNISTD_H unistd.h ${include_locations})

if (HAVE_UNISTD_H)
  file (APPEND ${WCSLIB_config} "/* Define to 1 if you have the <unistd.h> header file. */\n")
  file (APPEND ${WCSLIB_config} "\#define HAVE_UNISTD_H 1\n\n")
endif (HAVE_UNISTD_H)

## Check header files for functions -------------

check_function_exists (floor  HAVE_FLOOR  )
check_function_exists (memset HAVE_MEMSET )
check_function_exists (pow    HAVE_POW    )
check_function_exists (sqrt   HAVE_SQRT   )
check_function_exists (strchr HAVE_STRCHR )
check_function_exists (strstr HAVE_STRSTR )

file (APPEND ${WCSLIB_config} "/* Define to 1 if any of the following functions are defined. */\n")
file (APPEND ${WCSLIB_config} "\#define HAVE_FLOOR ${HAVE_FLOOR}\n")
file (APPEND ${WCSLIB_config} "\#define HAVE_MEMSET ${HAVE_MEMSET}\n")
file (APPEND ${WCSLIB_config} "\#define HAVE_POW ${HAVE_POW}\n")
file (APPEND ${WCSLIB_config} "\#define HAVE_SQRT ${HAVE_SQRT}\n")
file (APPEND ${WCSLIB_config} "\#define HAVE_STRCHR ${HAVE_STRCHR}\n")
file (APPEND ${WCSLIB_config} "\#define HAVE_STRSTR ${HAVE_STRSTR}\n")

## -----------------------------------------------------------------------------
## Files processed by Flex
##
##  FILES=`ls *.l | sed s/"\.l"//`
##  for FILE in $FILES ; { flex -t -P$FILE $FILE.l > $FILE.lcc ; }

set (WCSLIB_flex_inputs
  fitshdr
  wcspih
  wcsulex
  wcsutrn
)

if (flex_bin)
  foreach (src ${WCSLIB_flex_inputs})
    message (STATUS "Flex processing ${src}...")
    execute_process (
      WORKING_DIRECTORY ${WCSLIB_SOURCE_DIR}/C
      COMMAND flex -o${WCSLIB_BINARY_DIR}/C/${src}.c -P${src} ${src}.l
      TIMEOUT 20
      ERROR_VARIABLE flex_error
      OUTPUT_QUIET
      )
    if (flex_error)
      message (SEND_ERROR "There was an error processing ${src}.l!")
      message (SEND_ERROR ${flex_error})
    endif (flex_error)
  endforeach (src)
else (flex_bin)
  message (SEND_ERROR "Unable to process flex input files!")
endif (flex_bin)

## -----------------------------------------------------------------------------
## Sources and instructions to build the library

file (GLOB WCSLIB_headers *.h)

set (WCSLIB_sources 
  cel.c
  lin.c
  log.c
  prj.c
  spc.c
  sph.c
  spx.c
  tab.c
  wcs.c
  wcsfix.c
  wcshdr.c
  wcstrig.c
  wcsunits.c
  wcsutil.c
  ${WCSLIB_BINARY_DIR}/C/fitshdr.c
  ${WCSLIB_BINARY_DIR}/C/wcspih.c
  ${WCSLIB_BINARY_DIR}/C/wcsulex.c
  ${WCSLIB_BINARY_DIR}/C/wcsutrn.c
)

include_directories (
  ${WCSLIB_BINARY_DIR}/C
  ${WCSLIB_SOURCE_DIR}
  ${WCSLIB_SOURCE_DIR}/C
  ${WCSLIB_SOURCE_DIR}/C/test
  ${HAVE_LIMITS_H}
  ${HAVE_MATH_H}
  ${HAVE_STDLIB_H}
)

add_definitions (-fPIC)

add_library (wcs ${WCSLIB_sources})
target_link_libraries (wcs ${libm})

## -----------------------------------------------------------------------------
## Installation

install (TARGETS wcs
  RUNTIME DESTINATION bin
  LIBRARY DESTINATION lib
  ARCHIVE DESTINATION lib
  )

## Installation of header files

install (FILES ${WCSLIB_headers} ${WCSLIB_config}
  DESTINATION include/wcslib
  )

## -----------------------------------------------------------------------------
## Location of the test programs

add_subdirectory (test)

## -----------------------------------------------------------------------------
## Book-keeping of some of the temporary variables

mark_as_advanced (
  # header files
  HAVE_ERRNO_H
  HAVE_INTTYPES_H
  HAVE_LIMITS_H
  HAVE_MATH_H
  HAVE_MEMORY_H
  HAVE_STDINT_H
  HAVE_STDIO_H
  HAVE_STDLIB_H
  HAVE_STRINGS_H
  HAVE_STRING_H
  HAVE_SYS_STAT_H
  HAVE_SYS_TYPES_H
  HAVE_UNISTD_H
  # functions defined in header files
  HAVE_FLOOR
  HAVE_MEMSET
  HAVE_POW
  HAVE_SQRT
  HAVE_STRCHR
  HAVE_STRSTR
)
